name: Docker Image CI/CD

on:
  push:
#     branches: [ "master" ]
  pull_request:
#     branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:  
        - uses: actions/checkout@v3
        
        - name: Build image
          run: docker buildx build . --platform=linux/amd64 --file Dockerfile --tag iploc:$(date +%s)
          
        - name: Save image
          run: |
              set -eu
              sudo mkdir -p "/usr/src/iploc"
              cd "/usr/src/iploc"
              sudo docker save -o iploc.tar iploc

        - name: Deploy image to remote host
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            key: ${{ secrets.KEY }}
            port: ${{ secrets.PORT }}
            script: |
              whoami
              sudo mkdir -p /usr/src/iploc
              
        #         ## rsync -e "ssh -i ${{ secrets.key }} -o StrictHostKeyChecking=no" --rsync-path "sudo rsync" --archive --compress --delete iploc.tar .env ${{ vars.login }}:/usr/src/iploc
                
        # - name: Run container on remote host
        #   run: |
        #         ssh ${{ secrets.login }} 'bash -s' <<'ENDSSH'
        #           cd /usr/src/
        #           docker load -i iploc.tar
        #           docker run --env-file .env.prod -d -p 80:18001 iploc
        #         ENDSSH


           
     
    
